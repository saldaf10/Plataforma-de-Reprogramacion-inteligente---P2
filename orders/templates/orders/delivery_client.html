{% extends 'base.html' %}
{% block title %}Pedido #{{ order.id }} - PRI{% endblock %}

{% block content %}
<h2 class="mb-4">
  <span class="text-gradient">
    <i class="bi bi-box-seam"></i> Pedido #{{ order.id }}
  </span>
</h2>

<div class="row g-4">
  <!-- Estado de la Entrega -->
  <div class="col-lg-6">
    <div class="modern-card">
      <div class="modern-card-header">
        <h4 class="mb-0" style="color: var(--text-primary);">
          <i class="bi bi-truck"></i> Estado de Entrega
        </h4>
      </div>
      
      <div class="modern-card-body">
        <!-- Badge de Estado -->
        <div class="mb-3">
          {% if delivery.status == 'entregada' %}
            <span class="modern-badge badge-success" style="font-size: 1rem; padding: 0.5rem 1rem;">
              <i class="bi bi-check-circle"></i> {{ delivery.get_status_display }}
            </span>
          {% elif delivery.status == 'fallida' %}
            <span class="modern-badge badge-danger" style="font-size: 1rem; padding: 0.5rem 1rem;">
              <i class="bi bi-x-circle"></i> {{ delivery.get_status_display }}
            </span>
          {% elif delivery.status == 'en_ruta' %}
            <span class="modern-badge" style="background: #01c9ff; color: white; font-size: 1rem; padding: 0.5rem 1rem;">
              <i class="bi bi-truck"></i> {{ delivery.get_status_display }}
            </span>
          {% elif delivery.status == 'asignada' %}
            <span class="modern-badge badge-info" style="font-size: 1rem; padding: 0.5rem 1rem;">
              <i class="bi bi-person-check"></i> {{ delivery.get_status_display }}
            </span>
          {% elif delivery.status == 'reprogramada' %}
            <span class="modern-badge badge-warning" style="font-size: 1rem; padding: 0.5rem 1rem;">
              <i class="bi bi-arrow-repeat"></i> {{ delivery.get_status_display }}
            </span>
          {% else %}
            <span class="modern-badge badge-secondary" style="font-size: 1rem; padding: 0.5rem 1rem;">
              {{ delivery.get_status_display }}
            </span>
          {% endif %}
        </div>
        
        <!-- Barra de Progreso -->
        <div class="mb-3">
          <div style="background: var(--bg-tertiary); border-radius: var(--radius-full); height: 12px; overflow: hidden;">
            <div style="background: linear-gradient(135deg, var(--pri-blue) 0%, var(--pri-purple) 100%); height: 100%; width: {% if delivery.status == 'pendiente' %}10{% elif delivery.status == 'asignada' %}30{% elif delivery.status == 'en_ruta' %}60{% elif delivery.status == 'reprogramada' %}50{% elif delivery.status == 'entregada' %}100{% else %}0{% endif %}%; transition: width 0.5s ease;"></div>
          </div>
        </div>
        
        <!-- Hora Estimada - Rediseñada -->
        <div style="background: linear-gradient(135deg, rgba(1, 201, 255, 0.1) 0%, rgba(99, 102, 241, 0.1) 100%); border: 1px solid var(--pri-blue); border-radius: var(--radius-lg); padding: 1.25rem; margin-bottom: 1.5rem;">
          <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
            <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--pri-blue) 0%, var(--pri-purple) 100%); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; flex-shrink: 0;">
              <i class="bi bi-clock-fill"></i>
            </div>
            <div style="flex-grow: 1;">
              <div style="font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--pri-blue); margin-bottom: 0.25rem;">
                Hora Estimada de Entrega
              </div>
              <div style="font-size: 1.5rem; font-weight: 800; color: var(--text-primary);">
                {{ delivery.estimated_datetime|date:"d/m/Y H:i" }}
              </div>
            </div>
          </div>
        </div>
        
        <!-- Alerta de Motivo de Falla (si aplica) -->
        {% if delivery.status == 'fallida' and delivery.failure_reason %}
        <div class="modern-alert modern-alert-danger mb-3">
          <span class="modern-alert-icon">
            <i class="bi bi-exclamation-triangle"></i>
          </span>
          <div>
            <strong style="color: var(--text-primary);">Motivo de la falla:</strong>
            <p class="mb-0" style="color: var(--text-primary);">{{ delivery.failure_reason }}</p>
          </div>
        </div>
        {% endif %}
        
        <!-- Formulario de Reprogramación para Cliente -->
        {% if delivery.status == 'pendiente' or delivery.status == 'asignada' or delivery.status == 'reprogramada' or delivery.status == 'fallida' %}
        <div style="padding: 1.5rem; background: {% if delivery.status == 'fallida' %}#fff5f5{% else %}var(--bg-secondary){% endif %}; border-radius: var(--radius-lg); border: 2px dashed {% if delivery.status == 'fallida' %}#ef4444{% else %}var(--pri-blue){% endif %}; margin-bottom: 1.5rem;">
          <h5 style="color: var(--text-primary); font-weight: 700; margin-bottom: 0.5rem;">
            <i class="bi bi-{% if delivery.status == 'fallida' %}arrow-repeat{% else %}calendar-event{% endif %}" style="color: {% if delivery.status == 'fallida' %}#ef4444{% else %}var(--pri-blue){% endif %};"></i>
            {% if delivery.status == 'fallida' %}¿Quieres reintentar la entrega?{% else %}¿Necesitas cambiar la fecha de entrega?{% endif %}
          </h5>
          <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
            {% if delivery.status == 'fallida' %}
              Tu entrega anterior no pudo completarse. Puedes programar un nuevo intento seleccionando una fecha y horario conveniente.
            {% else %}
              Puedes reprogramar tu entrega seleccionando una nueva fecha y horario.
            {% endif %}
          </p>
          
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="reschedule">
            
            <div class="row g-3">
              <div class="col-md-7">
                <div class="modern-form-group">
                  <label class="modern-form-label">
                    <i class="bi bi-calendar"></i> Nueva Fecha de Entrega
                  </label>
                  <input type="date" class="modern-form-control" name="scheduled_date" 
                         value="{% if delivery.scheduled_date %}{{ delivery.scheduled_date|date:'Y-m-d' }}{% endif %}"
                         min="{{ today|date:'Y-m-d' }}" required>
                </div>
              </div>
              <div class="col-md-5">
                <div class="modern-form-group">
                  <label class="modern-form-label">
                    <i class="bi bi-clock"></i> Franja Horaria (opcional)
                  </label>
                  <input type="text" class="modern-form-control" name="scheduled_window" 
                         placeholder="Ej: 14:00-16:00"
                         value="{{ delivery.scheduled_window }}">
                </div>
              </div>
            </div>
            
            <button type="submit" class="btn-modern btn-primary-modern w-100 mt-3" style="{% if delivery.status == 'fallida' %}background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);{% endif %}">
              <i class="bi bi-{% if delivery.status == 'fallida' %}arrow-repeat{% else %}calendar-check{% endif %}"></i>
              {% if delivery.status == 'fallida' %}Programar Reintento de Entrega{% else %}Reprogramar Entrega{% endif %}
            </button>
          </form>
        </div>
        {% elif delivery.status == 'en_ruta' %}
        <div class="modern-alert modern-alert-info mb-3">
          <span class="modern-alert-icon">
            <i class="bi bi-info-circle"></i>
          </span>
          <div>
            <strong style="color: var(--text-primary);">Tu pedido está en camino</strong>
            <p class="mb-0" style="color: var(--text-primary);">El repartidor ya está en ruta, por lo que no es posible reprogramar en este momento.</p>
          </div>
        </div>
        {% elif delivery.status == 'entregada' %}
        <div class="modern-alert modern-alert-success mb-3">
          <span class="modern-alert-icon">
            <i class="bi bi-check-circle"></i>
          </span>
          <div>
            <strong style="color: var(--text-primary);">¡Pedido Entregado!</strong>
            <p class="mb-0" style="color: var(--text-primary);">Tu pedido fue entregado exitosamente.</p>
          </div>
        </div>
        {% else %}
        <!-- Otros estados sin acciones especiales -->
        {% endif %}
        
        <!-- Información Adicional -->
        {% if delivery.scheduled_date %}
        <div style="padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius-md); border-left: 3px solid var(--pri-blue); margin-bottom: 1rem;">
          <i class="bi bi-calendar-check" style="color: var(--pri-blue);"></i>
          <strong style="color: var(--text-primary);">Programado:</strong>
          <span style="color: var(--text-primary);">{{ delivery.scheduled_date }}</span>
          {% if delivery.scheduled_window %}
            <span style="color: var(--pri-blue); font-weight: 600;">({{ delivery.scheduled_window }})</span>
          {% endif %}
        </div>
        {% endif %}
        
        {% if delivery.notes %}
        <div style="padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius-md); margin-bottom: 1rem;">
          <div style="font-size: 0.85rem; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">
            <i class="bi bi-chat-left-text"></i> Notas
          </div>
          <div style="color: var(--text-primary);">{{ delivery.notes }}</div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  
  <!-- Resumen de Compra -->
  <div class="col-lg-6">
    <div class="modern-card">
      <div class="modern-card-header">
        <h4 class="mb-0" style="color: var(--text-primary);">
          <i class="bi bi-bag-check"></i> Resumen de Compra
        </h4>
      </div>
      
      <div class="modern-card-body" style="padding: 0;">
        <div style="max-height: 400px; overflow-y: auto;">
          {% for it in order.items.all %}
          <div style="padding: 1rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
            <div style="flex-grow: 1;">
              <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">{{ it.product.name }}</div>
              <div style="color: var(--text-secondary); font-size: 0.9rem;">Cantidad: {{ it.quantity }}</div>
            </div>
            <div style="font-weight: 700; color: var(--pri-blue); font-size: 1.1rem;">
              ${{ it.get_line_total }}
            </div>
          </div>
          {% endfor %}
        </div>
        
        <div style="padding: 1.5rem; border-top: 2px solid var(--border-color);">
          <div class="d-flex justify-content-between align-items-center">
            <span style="font-size: 1.25rem; font-weight: 700; color: var(--text-primary);">Total</span>
            <span style="font-size: 2rem; font-weight: 900; background: linear-gradient(135deg, #01c9ff 0%, #6366f1 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
              ${{ order.total_amount }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Historial de Eventos -->
<div class="row mt-4">
  <div class="col-12">
    <div class="modern-card">
      <div class="modern-card-header">
        <h4 class="mb-0" style="color: var(--text-primary);">
          <i class="bi bi-clock-history"></i> Historial de Eventos
        </h4>
      </div>
      
      <div class="modern-card-body" style="padding: 0;">
        <div class="table-responsive">
          <table class="modern-table">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Usuario</th>
                <th>De</th>
                <th>A</th>
                <th>Notas</th>
                <th>Foto</th>
              </tr>
            </thead>
            <tbody>
              {% for e in events %}
              <tr>
                <td style="color: var(--text-primary); font-weight: 500;">{{ e.created_at|date:"d/m/Y H:i" }}</td>
                <td style="color: var(--text-primary); font-weight: 500;">
                  {% if e.user %}
                    <i class="bi bi-person"></i> {{ e.user.username }}
                  {% else %}
                    <span style="color: var(--text-muted);">-</span>
                  {% endif %}
                </td>
                <td>
                  {% if e.status_before %}
                    <span style="color: var(--text-secondary);">{{ e.status_before }}</span>
                  {% else %}
                    <span style="color: var(--text-muted);">-</span>
                  {% endif %}
                </td>
                <td>
                  {% if e.status_after %}
                    <span style="color: var(--pri-blue); font-weight: 600;">{{ e.status_after }}</span>
                  {% else %}
                    <span style="color: var(--text-muted);">-</span>
                  {% endif %}
                </td>
                <td style="color: var(--text-primary);">{{ e.notes|default:"-" }}</td>
                <td>
                  {% if e.photo %}
                    <img src="{{ e.photo.url }}" alt="foto" style="height:40px; border-radius: var(--radius-md); cursor: pointer;" 
                         data-bs-toggle="modal" data-bs-target="#imageModal" 
                         onclick="showImageModal('{{ e.photo.url }}', 'Evento del {{ e.created_at|date:"d/m/Y H:i" }}')">
                  {% else %}
                    <span style="color: var(--text-muted);">-</span>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="6" class="text-center" style="padding: 2rem; color: var(--text-muted);">
                  <i class="bi bi-inbox" style="font-size: 2rem; display: block; margin-bottom: 0.5rem;"></i>
                  Sin eventos registrados
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Comentarios -->
{% if comments %}
<div class="row mt-4">
  <div class="col-12">
    <div class="modern-card">
      <div class="modern-card-header">
        <h4 class="mb-0" style="color: var(--text-primary);">
          <i class="bi bi-chat-left-text"></i> Comentarios
        </h4>
      </div>
      
      <div class="modern-card-body">
        {% for c in comments %}
        <div style="padding: 1.5rem; border: 1px solid var(--border-color); border-radius: var(--radius-lg); margin-bottom: 1rem; background: var(--bg-secondary);">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <div style="font-weight: 700; color: var(--text-primary); margin-bottom: 0.25rem;">
                <i class="bi bi-person-circle"></i>
                {% if c.user %}{{ c.user.username }}{% else %}Anónimo{% endif %}
              </div>
              <div style="font-size: 0.85rem; color: var(--text-secondary);">
                <span class="modern-badge badge-secondary" style="font-size: 0.75rem;">{{ c.role|capfirst }}</span>
                <span style="margin-left: 0.5rem;">{{ c.created_at|date:"d/m/Y H:i" }}</span>
              </div>
            </div>
          </div>
          <div style="color: var(--text-primary); line-height: 1.6; margin-top: 1rem;">{{ c.message }}</div>
          {% if c.photo %}
            <img src="{{ c.photo.url }}" style="max-height:150px; border-radius: var(--radius-md); margin-top: 1rem; cursor: pointer; border: 2px solid var(--border-color);" 
                 data-bs-toggle="modal" data-bs-target="#imageModal" 
                 onclick="showImageModal('{{ c.photo.url }}', 'Comentario del {{ c.created_at|date:"d/m/Y H:i" }}')">
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Modal para ampliar imágenes -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" style="background: var(--bg-primary); border-radius: var(--radius-xl); overflow: hidden;">
      <div class="modal-header" style="background: var(--bg-secondary); border-bottom: 1px solid var(--border-color);">
        <h5 class="modal-title" id="imageModalLabel" style="color: var(--text-primary); font-weight: 700;">
          <i class="bi bi-image"></i> Imagen de Evidencia
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center" style="padding: 2rem;">
        <img id="modalImage" src="" alt="Imagen ampliada" class="img-fluid rounded" style="max-height: 70vh; border: 2px solid var(--border-color); border-radius: var(--radius-lg);">
        <div class="mt-3">
          <small id="modalImageInfo" style="color: var(--text-secondary); font-weight: 500;"></small>
        </div>
      </div>
      <div class="modal-footer" style="background: var(--bg-secondary); border-top: 1px solid var(--border-color);">
        <button type="button" class="btn-modern btn-secondary-modern" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> Cerrar
        </button>
        <a id="downloadImage" href="#" class="btn-modern btn-primary-modern" download>
          <i class="bi bi-download"></i> Descargar
        </a>
      </div>
    </div>
  </div>
</div>

<style>
.cursor-pointer {
  cursor: pointer;
  transition: opacity 0.2s;
}

.cursor-pointer:hover {
  opacity: 0.8;
}
</style>

<script>
function showImageModal(imageUrl, imageInfo) {
  document.getElementById('modalImage').src = imageUrl;
  document.getElementById('modalImageInfo').textContent = imageInfo;
  document.getElementById('downloadImage').href = imageUrl;
}
</script>
{% endblock %}
