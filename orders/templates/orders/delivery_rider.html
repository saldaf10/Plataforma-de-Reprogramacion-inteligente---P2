{% extends 'base.html' %}
{% block title %}Entrega #{{ order.id }}{% endblock %}
{% block content %}
<h3>Entrega ‚Äî Pedido #{{ order.id }}</h3>
<div class="row">
  <div class="col-md-6">
    <div class="card card-body mb-3">
      <h6>Resumen del pedido</h6>
      <p><strong>Cliente:</strong> {{ order.full_name }} ({{ order.email }})</p>
      <p><strong>Direcci√≥n:</strong> {{ order.address }}, {{ order.city }}</p>
      <p><strong>Total:</strong> ${{ order.total_amount }}</p>
      <ul class="list-group list-group-flush">
        {% for it in order.items.all %}
        <li class="list-group-item d-flex justify-content-between"><span>{{ it.product.name }} x {{ it.quantity }}</span><strong>${{ it.get_line_total }}</strong></li>
        {% endfor %}
      </ul>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card card-body">
      <div class="mb-2">Estado actual: <span class="badge bg-secondary">{{ delivery.get_status_display }}</span></div>
      <div class="mb-3">Programado: {% if delivery.scheduled_date %}{{ delivery.scheduled_date }}{% else %}-{% endif %} {% if delivery.scheduled_window %}({{ delivery.scheduled_window }}){% endif %}</div>
      <div class="col-12">
        <div class="alert alert-info mb-2">Hora estimada: <strong>{{ delivery.estimated_datetime|date:"d/m/Y H:i" }}</strong></div>
      </div>
      
      <!-- Botones de notificaci√≥n - Solo para pedidos activos -->
      {% if can_send_notifications and is_modifiable %}
      <div class="col-12 mb-3">
        <h6 class="text-primary">üì± Notificar al Cliente</h6>
        <div class="btn-group-vertical w-100" role="group">
          <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#approachingModal">
            üöö Aproxim√°ndose
          </button>
          <button type="button" class="btn btn-outline-success btn-sm" onclick="sendNotification('leaving')">
            üöÄ Saliendo
          </button>
          <button type="button" class="btn btn-outline-warning btn-sm" onclick="sendNotification('arriving_soon')">
            ‚è∞ Llegando pronto (3 min)
          </button>
          <button type="button" class="btn btn-outline-info btn-sm" onclick="sendNotification('arrived')">
            üè† He llegado
          </button>
          <button type="button" class="btn btn-outline-success btn-sm" onclick="sendNotification('delivered')">
            ‚úÖ Entregado
          </button>
        </div>
      </div>
      {% else %}
      <div class="col-12 mb-3">
        <div class="alert alert-secondary">
          <i class="bi bi-info-circle"></i> Las notificaciones al cliente solo est√°n disponibles para pedidos en ruta o reprogramados.
        </div>
      </div>
      {% endif %}

      {% if is_modifiable %}
      <form method="post" enctype="multipart/form-data" class="row g-2" id="deliveryForm">{% csrf_token %}
        <div class="col-12">
          <label class="form-label">Comentarios</label>
          <textarea class="form-control" name="notes" rows="3" placeholder="Comentarios para el estado">{{ delivery.notes }}</textarea>
        </div>
        <div class="col-12">
          <label class="form-label">Foto</label>
          {% if delivery.photo %}
            <img class="img-fluid rounded mb-2 cursor-pointer" src="{{ delivery.photo.url }}" alt="Evidencia"
                 data-bs-toggle="modal" data-bs-target="#imageModal" 
                 onclick="showImageModal('{{ delivery.photo.url }}', 'Evidencia de entrega')">
          {% endif %}
          <input type="file" class="form-control" name="photo" accept="image/*">
        </div>
        <div class="col-12">
          <label class="form-label">Actualizar estado</label>
          <select class="form-select" name="action">
            <option value="en_ruta" {% if delivery.status == 'en_ruta' %}selected{% endif %}>En ruta</option>
            <option value="entregada" {% if delivery.status == 'entregada' %}selected{% endif %}>Entregada</option>
            <option value="fallida" {% if delivery.status == 'fallida' %}selected{% endif %}>Fallida</option>
            <option value="reprogramada" {% if delivery.status == 'reprogramada' %}selected{% endif %}>Reprogramada</option>
          </select>
        </div>
        <div class="col-12 d-grid mt-2">
          <button class="btn btn-primary">Guardar</button>
        </div>
      </form>
      {% else %}
      <div class="alert alert-warning">
        <h6><i class="bi bi-lock"></i> Pedido Bloqueado</h6>
        <p class="mb-0">Este pedido no puede ser modificado porque est√° en estado final ({{ delivery.get_status_display }}).</p>
      </div>
      {% endif %}

      <!-- Modal para notificaci√≥n de aproximaci√≥n -->
      <div class="modal fade" id="approachingModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">üöö Notificar Aproximaci√≥n</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" id="approachingForm">
              {% csrf_token %}
              <input type="hidden" name="action" value="send_notification">
              <input type="hidden" name="notification_type" value="approaching">
              <div class="modal-body">
                <div class="mb-3">
                  <label class="form-label">Tiempo estimado de llegada (minutos):</label>
                  <input type="number" class="form-control" name="estimated_minutes" value="30" min="1" max="120">
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary">Enviar Notificaci√≥n</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Formulario oculto para otras notificaciones -->
      <form method="post" id="notificationForm" style="display: none;">
        {% csrf_token %}
        <input type="hidden" name="action" value="send_notification">
        <input type="hidden" name="notification_type" id="notificationType">
      </form>

      <script>
        function sendNotification(type) {
          document.getElementById('notificationType').value = type;
          document.getElementById('notificationForm').submit();
        }
      </script>

      <!-- Modal para ampliar im√°genes -->
      <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="imageModalLabel">Imagen de Evidencia</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
              <img id="modalImage" src="" alt="Imagen ampliada" class="img-fluid rounded" style="max-height: 70vh;">
              <div class="mt-3">
                <small id="modalImageInfo" class="text-muted"></small>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
              <a id="downloadImage" href="#" class="btn btn-primary" download>
                <i class="bi bi-download"></i> Descargar
              </a>
            </div>
          </div>
        </div>
      </div>

      <style>
      .cursor-pointer {
        cursor: pointer;
        transition: opacity 0.2s;
      }

      .cursor-pointer:hover {
        opacity: 0.8;
      }
      </style>

      <script>
      function showImageModal(imageUrl, imageInfo) {
        document.getElementById('modalImage').src = imageUrl;
        document.getElementById('modalImageInfo').textContent = imageInfo;
        document.getElementById('downloadImage').href = imageUrl;
      }
      </script>
    </div>
  </div>
</div>
{% endblock %}

